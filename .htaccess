# Enable rewrite engine and follow symlinks
RewriteEngine On
Options +FollowSymLinks

# Force HTTPS
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Set default character set and content type
AddDefaultCharset utf-8
DefaultLanguage en-US
AddType application/x-httpd-php .php

# Security headers
Header set X-XSS-Protection "1; mode=block"
Header set X-Content-Type-Options "nosniff"
Header set X-Frame-Options "SAMEORIGIN"
Header set Referrer-Policy "strict-origin-when-cross-origin"
Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# Enable CORS - Allow requests from same origin (handled by browser)
# Note: For cross-origin requests, configure in application code
# Header set Access-Control-Allow-Origin "https://goldtree-app-cf573e5647cf.herokuapp.com"
Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
Header set Access-Control-Allow-Headers "Content-Type, Authorization"

# Prevent directory listing
Options -Indexes

# API endpoints
RewriteRule ^api/members/([0-9]+)$ /crud/members/get_member.php?id=$1 [L,QSA]
RewriteRule ^api/events/([0-9]+)$ /crud/events/get_event.php?id=$1 [L,QSA]
RewriteRule ^api/donations/([0-9]+)$ /crud/donations/get_donation.php?id=$1 [L,QSA]
RewriteRule ^api/notifications/([0-9]+)$ /crud/notifications/get_notification.php?id=$1 [L,QSA]

# Main application routes
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^ index.php [QSA,L]

# Prevent access to sensitive files
<FilesMatch "^(\.env|composer\.json|composer\.lock|package\.json|Procfile|\.gitignore)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Cache control for static assets
<FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js)$">
    Header set Cache-Control "max-age=31536000, public"
</FilesMatch>

# Error documents
ErrorDocument 404 /errors/404.php
ErrorDocument 500 /errors/500.php

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css text/javascript application/xml application/xhtml+xml application/rss+xml application/javascript application/x-javascript application/json
</IfModule>